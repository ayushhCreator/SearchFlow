# SearXNG Integration Guide for SearchFlow

This document explains how to set up, configure, and use SearXNG in SearchFlow.

---

## What is SearXNG?

**SearXNG** is a privacy-friendly meta-search engine that:

- Searches multiple search engines simultaneously (Google, Bing, DuckDuckGo, etc.)
- No ads, no tracking, no profiling
- Self-hosted (runs on your own server)
- Completely open-source
- Returns results in multiple formats (JSON, HTML, RSS)

### Why SearXNG for SearchFlow?

- **Privacy:** No user tracking
- **Control:** Run on your infrastructure
- **Flexibility:** Search multiple engines with one query
- **Integration:** Easy REST API
- **No API keys needed** (unlike Google Search API)

---

## Part 1: Running SearXNG with Docker

### Option A: Using docker-compose (Recommended)

Your project already includes SearXNG in `docker-compose.yml`:

```bash
make docker-up
```

This starts:

- **FastAPI API** on `http://localhost:8007`
- **SearXNG** on `http://localhost:8888`

### Option B: Running SearXNG Standalone

```bash
docker run -d \
  --name searxng \
  -p 8888:8888 \
  -e SEARXNG_SECRET=your_secret_key \
  searxng/searxng:latest
```

### Verify SearXNG is Running

```bash
curl http://localhost:8888
```

You should see the SearXNG web interface HTML response.

---

## Part 2: Understanding SearXNG API

### Basic Search Request

```bash
curl "http://localhost:8888/search?q=python&format=json"
```

### Request Parameters

| Parameter    | Type   | Example              | Description                       |
| ------------ | ------ | -------------------- | --------------------------------- |
| `q`          | string | `python programming` | Search query                      |
| `format`     | string | `json`               | Response format (json, html, csv) |
| `engines`    | string | `google,bing`        | Specific engines to use           |
| `pageno`     | int    | `1`                  | Page number for pagination        |
| `safesearch` | int    | `1`                  | Safe search level (0-2)           |
| `language`   | string | `en`                 | Language code                     |

### Response Format (JSON)

```json
{
  "query": "python programming",
  "number_of_results": 1234,
  "results": [
    {
      "title": "Welcome to Python.org",
      "url": "https://www.python.org",
      "content": "The official home of the Python Programming Language"
    },
    {
      "title": "Python (programming language) - Wikipedia",
      "url": "https://en.wikipedia.org/wiki/Python_(programming_language)",
      "content": "Python is a high-level, interpreted programming language..."
    }
  ]
}
```

---

## Part 3: SearXNG Client Implementation

The SearchFlow project includes a SearXNG client at `app/search/searxng_client.py`.

### Current Implementation

```python
from httpx import AsyncClient
from app.core.config import settings
import logging

logger = logging.getLogger(__name__)

class SearXNGClient:
    """Client for interacting with SearXNG search engine"""

    def __init__(self, base_url: str = None):
        self.base_url = base_url or settings.SEARXNG_URL
        self.client = AsyncClient(timeout=30.0)

    async def search(self, query: str, engines: str = None,
                     language: str = "en", safesearch: int = 1):
        """
        Execute a search query via SearXNG

        Args:
            query: Search query string
            engines: Comma-separated list of engines (optional)
            language: Language code (default: en)
            safesearch: Safe search level 0-2 (default: 1)

        Returns:
            List of search results
        """
        try:
            params = {
                "q": query,
                "format": "json",
                "language": language,
                "safesearch": safesearch
            }

            if engines:
                params["engines"] = engines

            logger.info(f"Searching SearXNG: {query}")

            response = await self.client.get(
                f"{self.base_url}/search",
                params=params
            )

            response.raise_for_status()
            data = response.json()

            return data.get("results", [])

        except Exception as e:
            logger.error(f"SearXNG search failed: {e}")
            return []

    async def close(self):
        """Close the HTTP client"""
        await self.client.aclose()
```

---

## Part 4: Configuration

### Environment Variables

Set in `.env` or in Docker environment:

```bash
# SearXNG Configuration
SEARXNG_URL=http://localhost:8888
SEARXNG_SECRET=your_secret_key_here
SEARXNG_ENGINES=google,bing,duckduckgo
```

### In `app/core/config.py`

```python
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # ... existing settings ...

    SEARXNG_URL: str = "http://localhost:8888"
    SEARXNG_SECRET: str = "default_secret"
    SEARXNG_ENGINES: str = "google,bing,duckduckgo"

    class Config:
        env_file = ".env"
```

---

## Part 5: Using SearXNG in FastAPI Endpoints

### Example 1: Basic Search Endpoint

```python
from fastapi import APIRouter, Depends
from pydantic import BaseModel
from app.search.searxng_client import SearXNGClient

router = APIRouter(prefix="/api/v1", tags=["search"])

class SearchRequest(BaseModel):
    query: str
    engines: str = None
    language: str = "en"

@router.post("/search")
async def search(
    request: SearchRequest,
    searxng: SearXNGClient = Depends(get_searxng_client)
):
    """Search the web via SearXNG"""
    results = await searxng.search(
        query=request.query,
        engines=request.engines,
        language=request.language
    )

    return {
        "query": request.query,
        "results": results,
        "total": len(results)
    }

async def get_searxng_client():
    """Dependency injection for SearXNG client"""
    client = SearXNGClient()
    try:
        yield client
    finally:
        await client.close()
```

### Example 2: Search with AI Processing

```python
from app.ai.dspy_pipeline import DSPyPipeline

@router.post("/search/enhanced")
async def enhanced_search(
    request: SearchRequest,
    searxng: SearXNGClient = Depends(get_searxng_client)
):
    """Search and clean results with AI"""

    # Get raw results from SearXNG
    raw_results = await searxng.search(request.query)

    # Process with AI/DSPy
    pipeline = DSPyPipeline()
    cleaned_results = pipeline.process_results(raw_results)

    return {
        "query": request.query,
        "raw_count": len(raw_results),
        "cleaned_results": cleaned_results,
        "confidence": pipeline.confidence_score
    }
```

---

## Part 6: Testing SearXNG Integration

### Test 1: Direct SearXNG Access

```bash
# Using make command
make test

# Or manually
pytest tests/test_searxng.py -v
```

### Create `tests/test_searxng.py`

```python
import pytest
from app.search.searxng_client import SearXNGClient

@pytest.mark.asyncio
async def test_searxng_search():
    """Test SearXNG search functionality"""
    client = SearXNGClient()

    results = await client.search("python programming")

    assert isinstance(results, list)
    assert len(results) > 0

    # Check result structure
    for result in results[:5]:
        assert "title" in result
        assert "url" in result

    await client.close()

@pytest.mark.asyncio
async def test_searxng_connection():
    """Test SearXNG connection"""
    client = SearXNGClient()

    # Try a simple query
    results = await client.search("test")

    # Should get some results
    assert isinstance(results, list)

    await client.close()
```

### Test 2: API Endpoint

```bash
curl -X POST http://localhost:8007/api/v1/search \
  -H "Content-Type: application/json" \
  -d '{"query": "python programming"}'
```

---

## Part 7: Common Issues & Solutions

### Issue 1: "Connection refused" to SearXNG

**Problem:** Getting connection error when API tries to reach SearXNG

**Solution:**

```bash
# Check if SearXNG is running
docker ps | grep searxng

# If not running, start it
make docker-up

# Verify SearXNG is accessible
curl http://localhost:8888
```

### Issue 2: SearXNG returns empty results

**Problem:** Searches return 0 results

**Solution:**

```bash
# Check SearXNG configuration
# View logs
docker logs searchflow-searxng-1

# Test with different query
curl "http://localhost:8888/search?q=google&format=json"

# Check which engines are enabled
curl http://localhost:8888/config
```

### Issue 3: Slow search responses

**Problem:** Searches take 10+ seconds

**Solution:**

```bash
# Limit to faster engines
SEARXNG_ENGINES=duckduckgo,bing

# Increase timeout in config.py
SEARCH_TIMEOUT=60  # seconds

# Reduce engines in docker-compose.yml
# Edit searxng service configuration
```

### Issue 4: 503 Service Unavailable

**Problem:** Getting 503 errors from SearXNG

**Solution:**

- Check Docker container health: `docker ps`
- Check container logs: `docker logs searchflow-searxng-1`
- Restart SearXNG: `make docker-down && make docker-up`

---

## Part 8: Advanced Configuration

### SearXNG Docker Configuration

In `docker-compose.yml`:

```yaml
searxng:
  image: searxng/searxng:latest
  ports:
    - "8888:8888"
  environment:
    - SEARXNG_SECRET=your_secret_key_here
    - BASE_URL=http://localhost:8888
    - ENABLE_RATE_LIMIT=true
    - RATE_LIMIT_ON_INVALID_ANSWERS=true
  volumes:
    - searxng-data:/data
    - ./searxng-settings.yml:/etc/searxng/settings.yml
  networks:
    - searchflow_network
```

### Custom SearXNG Configuration

Create `searxng-settings.yml`:

```yaml
server:
  port: 8888
  bind_address: 0.0.0.0

search:
  autocomplete: duckduckgo
  autocomplete_min: 4

enable_doi_resolver: true

outgoing:
  request_timeout: 5
  max_retries: 1

result_proxy:
  enable: false

engines:
  - name: google
    enable: true
  - name: bing
    enable: true
  - name: duckduckgo
    enable: true
  - name: wikipedia
    enable: true
```

---

## Part 9: Workflow Example

### Complete Search Flow

```
User Query
    â†“
FastAPI Endpoint /api/v1/search
    â†“
SearXNGClient.search(query)
    â†“
HTTP Request to SearXNG
    â†“
SearXNG searches multiple engines
    â†“
Results returned as JSON
    â†“
DSPy Pipeline cleans results
    â†“
AI reasoning applied
    â†“
Structured output (JSON + Markdown)
    â†“
Response to user
```

---

## Part 10: Next Steps

Now that you understand SearXNG:

1. **âœ… Verify SearXNG is running:**

   ```bash
   make docker-up
   curl http://localhost:8888
   ```

2. **Test the integration:**

   ```bash
   make test
   ```

3. **Try the API:**

   ```bash
   curl -X POST http://localhost:8007/api/v1/search \
     -H "Content-Type: application/json" \
     -d '{"query": "your search query"}'
   ```

4. **Implement AI processing:**

   - Add DSPy reasoning
   - Clean and structure results
   - Add confidence scoring

5. **Deploy:**
   - Push to GitHub
   - GitHub Actions will test & build
   - Deploy to production

---

## Summary

SearXNG provides SearchFlow with:

âœ… **Live web search** - Always current results
âœ… **Privacy-first** - No tracking
âœ… **Multiple engines** - Comprehensive results
âœ… **Easy integration** - Simple REST API
âœ… **Self-hosted** - Full control
âœ… **No API keys** - No cost

**SearchFlow = Live Web Data + AI Reasoning = Structured Knowledge** ðŸš€
