# CI/CD Setup Guide for SearchFlow

This document explains the complete CI/CD pipeline setup for SearchFlow.

## Overview

SearchFlow uses a multi-layered CI/CD approach:

1. **Local Pre-commit Hooks** - Run on your machine before commits
2. **GitHub Actions** - Automated testing, linting, building
3. **Docker** - Containerized deployment
4. **Development Makefile** - Convenient local commands

---

## 1. Local Development Setup (Pre-commit)

### Install Pre-commit Hooks

```bash
make pre-commit
```

Or manually:

```bash
pip install pre-commit
pre-commit install
```

### What Hooks Run?

When you run `git commit`, these checks automatically run:

- **Trailing whitespace** - Removes extra spaces
- **End-of-file fixer** - Ensures files end with newline
- **YAML validator** - Checks YAML syntax
- **Black** - Code formatting
- **isort** - Import sorting
- **Flake8** - Linting (PEP8 compliance)
- **MyPy** - Type checking

### Skip Hooks (Not Recommended)

```bash
git commit --no-verify
```

---

## 2. Local Testing & Development

### Install Dependencies

```bash
make install
```

This installs:

- FastAPI, Uvicorn, Pydantic (core)
- Pytest, pytest-asyncio, pytest-cov (testing)
- Black, flake8, isort, mypy (code quality)
- Pre-commit hooks

### Run Tests Locally

```bash
make test
```

Runs all tests with coverage report in `htmlcov/index.html`

### Lint Code

```bash
make lint
```

Checks code quality without fixing anything.

### Format Code

```bash
make format
```

Auto-fixes formatting with Black and isort.

### Run the Application

```bash
make run
```

Starts the API on `http://localhost:8007` with auto-reload.

---

## 3. GitHub Actions Workflows

### A. **tests.yml** - Automated Testing

**Triggers:** Push to main/develop or pull requests

**What it does:**

- Installs Python 3.12
- Installs dependencies via uv
- Runs pytest with coverage
- Uploads coverage to Codecov

**Access Results:** GitHub > Actions > Tests

---

### B. **lint.yml** - Code Quality Checks

**Triggers:** Push to main/develop or pull requests

**What it does:**

- Runs Black (formatting check)
- Runs isort (import sorting check)
- Runs Flake8 (linting)
- Runs MyPy (type checking)

**Note:** These run with `continue-on-error: true`, so failures don't block PRs.

**Access Results:** GitHub > Actions > Code Quality

---

### C. **build.yml** - Build & Deploy

**Triggers:** Push to main branch or version tags (v\*)

**What it does:**

- Builds Docker image for the API
- Pushes to Docker Hub (requires secrets)
- Runs Trivy security scan
- Uploads security scan results to GitHub

**Required Secrets in GitHub:**

```
DOCKER_USERNAME    # Your Docker Hub username
DOCKER_PASSWORD    # Your Docker Hub token
```

**Setup Secrets:**

1. Go to GitHub repo > Settings > Secrets and variables > Actions
2. Add `DOCKER_USERNAME` and `DOCKER_PASSWORD`

---

## 4. Docker Setup

### Build Images Locally

```bash
make docker-build
```

### Start Services

```bash
make docker-up
```

Starts:

- FastAPI on `http://localhost:8007`
- SearXNG on `http://localhost:8888`

### Stop Services

```bash
make docker-down
```

---

## 5. Understanding the Pipeline

### Local Development Flow

```
You write code
    ↓
git add .
    ↓
git commit
    ↓
Pre-commit hooks run locally ← Fixes formatting, catches errors
    ↓
If passes → Commit succeeds
If fails → Fix issues, commit again
```

### GitHub Actions Flow (After Push)

```
Code pushed to GitHub
    ↓
GitHub Actions triggers
    ↓
Parallel jobs run:
├─ tests.yml (pytest + coverage)
├─ lint.yml (black, flake8, mypy)
└─ build.yml (Docker build + push)
    ↓
Results shown in GitHub > Actions
    ↓
Pull Request shows pass/fail status
```

---

## 6. Requirements.txt Packages

| Package          | Purpose               |
| ---------------- | --------------------- |
| `fastapi`        | Web framework         |
| `uvicorn`        | ASGI server           |
| `pydantic`       | Data validation       |
| `httpx`          | Async HTTP client     |
| `pytest`         | Testing framework     |
| `pytest-asyncio` | Async test support    |
| `pytest-cov`     | Coverage reporting    |
| `black`          | Code formatter        |
| `flake8`         | Linting               |
| `isort`          | Import sorter         |
| `mypy`           | Type checker          |
| `python-dotenv`  | Environment variables |

---

## 7. Common Commands Reference

| Command           | What it does            |
| ----------------- | ----------------------- |
| `make help`       | Show all commands       |
| `make install`    | Install dependencies    |
| `make test`       | Run tests with coverage |
| `make lint`       | Check code quality      |
| `make format`     | Auto-format code        |
| `make clean`      | Remove cache files      |
| `make run`        | Start API locally       |
| `make docker-up`  | Start Docker services   |
| `make pre-commit` | Install git hooks       |

---

## 8. Troubleshooting

### Pre-commit hooks won't run

```bash
pre-commit install
pre-commit run --all-files
```

### Tests fail locally but pass in CI

Check Python version:

```bash
python --version  # Should be 3.12+
```

### Docker won't build

```bash
docker-compose down
docker system prune -a
make docker-build
```

### Port 8007 already in use

```bash
lsof -i :8007
kill -9 <PID>
```

---

## 9. Next Steps

After CI/CD is set up:

1. ✅ Make a test commit to verify pre-commit hooks work
2. ✅ Push to GitHub and watch Actions run
3. ✅ Set up Docker Hub secrets for automatic deployments
4. ✅ Monitor test coverage: aim for >80%
5. ✅ Set up branch protection rules in GitHub

---

## File Structure

```
SearchFlow/
├── .github/workflows/        # GitHub Actions
│   ├── tests.yml            # Testing workflow
│   ├── lint.yml             # Linting workflow
│   └── build.yml            # Build & deploy workflow
├── .pre-commit-config.yaml   # Pre-commit hooks config
├── Makefile                  # Development commands
├── requirements.txt          # All dependencies
└── pyproject.toml           # Project config
```
